<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <style>
            body {
                background-color: #222;
                text-align: center;
            }
            .canvas-container {
                display: inline-block;
                position: relative;
                margin-top: 2rem;
                width: 718px;
                border: 1px solid #fff;
            }
            .grid-line {
                position: absolute;
                background-color: #fff;
                pointer-events: none;
            }
            .grid-line.horizontal {
                left: 0;
                width: 718px;
                height: 1px;
            }
            .grid-line.vertical {
                top: 0;
                width: 1px;
                height: 363.5px;
            }
        </style>
    </head>
<body>

    <script id="vertex-shader" type="notjs">  
  
        attribute vec4 a_position;
        uniform mat4 u_matrix;

        void main() {
            gl_Position = u_matrix * a_position;
        }

    </script>
    
    <script id="fragment-shader" type="notjs">
    
        precision mediump float;
        uniform vec4 u_color;

        void main() {
            gl_FragColor = u_color;
        }

    </script>

    <div class="canvas-container">

        <div class="grid-line horizontal" style="top: 181.75px;"></div>

        <div class="grid-line vertical" style="left: 179.5px;"></div>
        <div class="grid-line vertical" style="left: 359px;"></div>
        <div class="grid-line vertical" style="left: 538.5px;"></div>

        <canvas width="1600" height="810"></canvas>
    </div>
    <script src="./data.js"></script>
    <script src="./earcut.min.js"></script>
    <script src="./m4.js"></script>
    <script>

        var pointSize = 2;
        var geometries = inflate(data);
        var buffer = createBuffer(geometries);

        var canvas = document.querySelector("canvas");
        var gl = canvas.getContext("webgl");
        var vertexShader = createShader(gl.VERTEX_SHADER, document.getElementById("vertex-shader").text);
        var fragmentShader = createShader(gl.FRAGMENT_SHADER, document.getElementById("fragment-shader").text);
        var program = createProgram(vertexShader, fragmentShader);

        var positionLocation = gl.getAttribLocation(program, "a_position");
        var matrixLocation = gl.getUniformLocation(program, "u_matrix");
        var colorLocation = gl.getUniformLocation(program, "u_color");

        var colors = [
            [1, 0, 0, 1],
            [0.85, 0, 0, 1],
            [0.7, 0, 0, 1],
            [0.55, 0, 0, 1]
        ];

        var scale = 1;
        var min = 0.5;
        var max = 20;
        var tx = gl.canvas.width / 2;
        var ty = gl.canvas.height / 2;
        var mouse = [tx, ty, 0, 1];
        var mx, my;

        gl.useProgram(program);
        gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(buffer.data), gl.STATIC_DRAW);
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, pointSize, gl.FLOAT, false, 0, 0);

        canvas.addEventListener("wheel", function(e) {
            e.preventDefault();
            requestAnimationFrame(function() {

                if(e.clientX !== mx || e.clientY !== my) {
                    mx = e.clientX;
                    my = e.clientY;
                    toCanvasVector(mx, my, mouse);
                    //tx = mouse[0];
                    //ty = mouse[1];
                }

                zoom(-e.deltaY * (e.deltaMode ? 120 : 1) / 500);
            });
        });

        canvas.addEventListener("click", function(e) {
            requestAnimationFrame(function() {
                if(e.clientX !== mx || e.clientY !== my) {
                    mx = e.clientX;
                    my = e.clientY;
                    toCanvasVector(mx, my, mouse);
                    //tx = mouse[0];
                    //ty = mouse[1];
                }
                zoom(1);
            });
        });

        onResize();

        function zoom(delta) {

            //scale = Math.max(min, Math.min(max, scale * Math.pow(2, delta)));

            delta = Math.pow(2, delta);
            scale = Math.max(min, Math.min(max, scale * delta));
            tx += (tx - mouse[0]) * (delta - 1);
            ty += (ty - mouse[1]) * (delta - 1);

            /*
            delta *= scale;
            tx += ((tx - mouse[0]) / scale) * delta;
            ty += ((ty - mouse[1]) / scale) * delta;
            scale += delta;
            */
    
            draw(scale, tx, ty);
        }

        function onResize() {
            var aspectRatio = gl.canvas.height / gl.canvas.width;
            var width = gl.canvas.parentElement.clientWidth;
            var height = (width * aspectRatio);

            gl.canvas.style.width = width + "px";
            gl.canvas.style.height = height + "px";
            gl.canvas.parentElement.style.height = height + "px";

            draw(scale, tx, ty);
        }

        function M4() {

            var matrix = identity();
    
            function identity() {
    
                var id = new Float32Array(16);

                id[ 0] = 1;
                id[ 1] = 0;
                id[ 2] = 0;
                id[ 3] = 0;
                id[ 4] = 0;
                id[ 5] = 1;
                id[ 6] = 0;
                id[ 7] = 0;
                id[ 8] = 0;
                id[ 9] = 0;
                id[10] = 1;
                id[11] = 0;
                id[12] = 0;
                id[13] = 0;
                id[14] = 0;
                id[15] = 1;
            
                return id;
            }

            function orthographic(left, right, bottom, top, near, far) {

                matrix[ 0] = 2 / (right - left);
                matrix[ 1] = 0;
                matrix[ 2] = 0;
                matrix[ 3] = 0;
                matrix[ 4] = 0;
                matrix[ 5] = 2 / (top - bottom);
                matrix[ 6] = 0;
                matrix[ 7] = 0;
                matrix[ 8] = 0;
                matrix[ 9] = 0;
                matrix[10] = 2 / (near - far);
                matrix[11] = 0;
                matrix[12] = (left + right) / (left - right);
                matrix[13] = (bottom + top) / (bottom - top);
                matrix[14] = (near + far) / (near - far);
                matrix[15] = 1;

                return this;
            }

            function multiply(m) {

                m = m.matrix ? m.matrix : m;

                var a00 = matrix[0 * 4 + 0];
                var a01 = matrix[0 * 4 + 1];
                var a02 = matrix[0 * 4 + 2];
                var a03 = matrix[0 * 4 + 3];
                var a10 = matrix[1 * 4 + 0];
                var a11 = matrix[1 * 4 + 1];
                var a12 = matrix[1 * 4 + 2];
                var a13 = matrix[1 * 4 + 3];
                var a20 = matrix[2 * 4 + 0];
                var a21 = matrix[2 * 4 + 1];
                var a22 = matrix[2 * 4 + 2];
                var a23 = matrix[2 * 4 + 3];
                var a30 = matrix[3 * 4 + 0];
                var a31 = matrix[3 * 4 + 1];
                var a32 = matrix[3 * 4 + 2];
                var a33 = matrix[3 * 4 + 3];

                var b00 = m[0 * 4 + 0];
                var b01 = m[0 * 4 + 1];
                var b02 = m[0 * 4 + 2];
                var b03 = m[0 * 4 + 3];
                var b10 = m[1 * 4 + 0];
                var b11 = m[1 * 4 + 1];
                var b12 = m[1 * 4 + 2];
                var b13 = m[1 * 4 + 3];
                var b20 = m[2 * 4 + 0];
                var b21 = m[2 * 4 + 1];
                var b22 = m[2 * 4 + 2];
                var b23 = m[2 * 4 + 3];
                var b30 = m[3 * 4 + 0];
                var b31 = m[3 * 4 + 1];
                var b32 = m[3 * 4 + 2];
                var b33 = m[3 * 4 + 3];

                matrix[ 0] = b00 * a00 + b01 * a10 + b02 * a20 + b03 * a30;
                matrix[ 1] = b00 * a01 + b01 * a11 + b02 * a21 + b03 * a31;
                matrix[ 2] = b00 * a02 + b01 * a12 + b02 * a22 + b03 * a32;
                matrix[ 3] = b00 * a03 + b01 * a13 + b02 * a23 + b03 * a33;
                matrix[ 4] = b10 * a00 + b11 * a10 + b12 * a20 + b13 * a30;
                matrix[ 5] = b10 * a01 + b11 * a11 + b12 * a21 + b13 * a31;
                matrix[ 6] = b10 * a02 + b11 * a12 + b12 * a22 + b13 * a32;
                matrix[ 7] = b10 * a03 + b11 * a13 + b12 * a23 + b13 * a33;
                matrix[ 8] = b20 * a00 + b21 * a10 + b22 * a20 + b23 * a30;
                matrix[ 9] = b20 * a01 + b21 * a11 + b22 * a21 + b23 * a31;
                matrix[10] = b20 * a02 + b21 * a12 + b22 * a22 + b23 * a32;
                matrix[11] = b20 * a03 + b21 * a13 + b22 * a23 + b23 * a33;
                matrix[12] = b30 * a00 + b31 * a10 + b32 * a20 + b33 * a30;
                matrix[13] = b30 * a01 + b31 * a11 + b32 * a21 + b33 * a31;
                matrix[14] = b30 * a02 + b31 * a12 + b32 * a22 + b33 * a32;
                matrix[15] = b30 * a03 + b31 * a13 + b32 * a23 + b33 * a33;

                return this;
            }

            function inverse() {

                var m00 = matrix[0 * 4 + 0];
                var m01 = matrix[0 * 4 + 1];
                var m02 = matrix[0 * 4 + 2];
                var m03 = matrix[0 * 4 + 3];
                var m10 = matrix[1 * 4 + 0];
                var m11 = matrix[1 * 4 + 1];
                var m12 = matrix[1 * 4 + 2];
                var m13 = matrix[1 * 4 + 3];
                var m20 = matrix[2 * 4 + 0];
                var m21 = matrix[2 * 4 + 1];
                var m22 = matrix[2 * 4 + 2];
                var m23 = matrix[2 * 4 + 3];
                var m30 = matrix[3 * 4 + 0];
                var m31 = matrix[3 * 4 + 1];
                var m32 = matrix[3 * 4 + 2];
                var m33 = matrix[3 * 4 + 3];
                var tmp_0  = m22 * m33;
                var tmp_1  = m32 * m23;
                var tmp_2  = m12 * m33;
                var tmp_3  = m32 * m13;
                var tmp_4  = m12 * m23;
                var tmp_5  = m22 * m13;
                var tmp_6  = m02 * m33;
                var tmp_7  = m32 * m03;
                var tmp_8  = m02 * m23;
                var tmp_9  = m22 * m03;
                var tmp_10 = m02 * m13;
                var tmp_11 = m12 * m03;
                var tmp_12 = m20 * m31;
                var tmp_13 = m30 * m21;
                var tmp_14 = m10 * m31;
                var tmp_15 = m30 * m11;
                var tmp_16 = m10 * m21;
                var tmp_17 = m20 * m11;
                var tmp_18 = m00 * m31;
                var tmp_19 = m30 * m01;
                var tmp_20 = m00 * m21;
                var tmp_21 = m20 * m01;
                var tmp_22 = m00 * m11;
                var tmp_23 = m10 * m01;

                var t0 = (tmp_0 * m11 + tmp_3 * m21 + tmp_4 * m31) -
                    (tmp_1 * m11 + tmp_2 * m21 + tmp_5 * m31);
                var t1 = (tmp_1 * m01 + tmp_6 * m21 + tmp_9 * m31) -
                    (tmp_0 * m01 + tmp_7 * m21 + tmp_8 * m31);
                var t2 = (tmp_2 * m01 + tmp_7 * m11 + tmp_10 * m31) -
                    (tmp_3 * m01 + tmp_6 * m11 + tmp_11 * m31);
                var t3 = (tmp_5 * m01 + tmp_8 * m11 + tmp_11 * m21) -
                    (tmp_4 * m01 + tmp_9 * m11 + tmp_10 * m21);

                var d = 1.0 / (m00 * t0 + m10 * t1 + m20 * t2 + m30 * t3);

                matrix[0] = d * t0;
                matrix[1] = d * t1;
                matrix[2] = d * t2;
                matrix[3] = d * t3;
                matrix[4] = d * ((tmp_1 * m10 + tmp_2 * m20 + tmp_5 * m30) -
                    (tmp_0 * m10 + tmp_3 * m20 + tmp_4 * m30));
                matrix[5] = d * ((tmp_0 * m00 + tmp_7 * m20 + tmp_8 * m30) -
                    (tmp_1 * m00 + tmp_6 * m20 + tmp_9 * m30));
                matrix[6] = d * ((tmp_3 * m00 + tmp_6 * m10 + tmp_11 * m30) -
                    (tmp_2 * m00 + tmp_7 * m10 + tmp_10 * m30));
                matrix[7] = d * ((tmp_4 * m00 + tmp_9 * m10 + tmp_10 * m20) -
                    (tmp_5 * m00 + tmp_8 * m10 + tmp_11 * m20));
                matrix[8] = d * ((tmp_12 * m13 + tmp_15 * m23 + tmp_16 * m33) -
                    (tmp_13 * m13 + tmp_14 * m23 + tmp_17 * m33));
                matrix[9] = d * ((tmp_13 * m03 + tmp_18 * m23 + tmp_21 * m33) -
                    (tmp_12 * m03 + tmp_19 * m23 + tmp_20 * m33));
                matrix[10] = d * ((tmp_14 * m03 + tmp_19 * m13 + tmp_22 * m33) -
                    (tmp_15 * m03 + tmp_18 * m13 + tmp_23 * m33));
                matrix[11] = d * ((tmp_17 * m03 + tmp_20 * m13 + tmp_23 * m23) -
                    (tmp_16 * m03 + tmp_21 * m13 + tmp_22 * m23));
                matrix[12] = d * ((tmp_14 * m22 + tmp_17 * m32 + tmp_13 * m12) -
                    (tmp_16 * m32 + tmp_12 * m12 + tmp_15 * m22));
                matrix[13] = d * ((tmp_20 * m32 + tmp_12 * m02 + tmp_19 * m22) -
                    (tmp_18 * m22 + tmp_21 * m32 + tmp_13 * m02));
                matrix[14] = d * ((tmp_18 * m12 + tmp_23 * m32 + tmp_15 * m02) -
                    (tmp_22 * m32 + tmp_14 * m02 + tmp_19 * m12));
                matrix[15] = d * ((tmp_22 * m22 + tmp_16 * m02 + tmp_21 * m12) -
                    (tmp_20 * m12 + tmp_23 * m22 + tmp_17 * m02));

                return this;
            }

            function translate(tx, ty, tz) {

                var m00 = matrix[0];
                var m01 = matrix[1];
                var m02 = matrix[2];
                var m03 = matrix[3];
                var m10 = matrix[1 * 4 + 0];
                var m11 = matrix[1 * 4 + 1];
                var m12 = matrix[1 * 4 + 2];
                var m13 = matrix[1 * 4 + 3];
                var m20 = matrix[2 * 4 + 0];
                var m21 = matrix[2 * 4 + 1];
                var m22 = matrix[2 * 4 + 2];
                var m23 = matrix[2 * 4 + 3];
                var m30 = matrix[3 * 4 + 0];
                var m31 = matrix[3 * 4 + 1];
                var m32 = matrix[3 * 4 + 2];
                var m33 = matrix[3 * 4 + 3];

                matrix[12] = m00 * tx + m10 * ty + m20 * tz + m30;
                matrix[13] = m01 * tx + m11 * ty + m21 * tz + m31;
                matrix[14] = m02 * tx + m12 * ty + m22 * tz + m32;
                matrix[15] = m03 * tx + m13 * ty + m23 * tz + m33;

                return this;
            }

            function scale(sx, sy, sz) {

                matrix[ 0] = sx * matrix[0 * 4 + 0];
                matrix[ 1] = sx * matrix[0 * 4 + 1];
                matrix[ 2] = sx * matrix[0 * 4 + 2];
                matrix[ 3] = sx * matrix[0 * 4 + 3];
                matrix[ 4] = sy * matrix[1 * 4 + 0];
                matrix[ 5] = sy * matrix[1 * 4 + 1];
                matrix[ 6] = sy * matrix[1 * 4 + 2];
                matrix[ 7] = sy * matrix[1 * 4 + 3];
                matrix[ 8] = sz * matrix[2 * 4 + 0];
                matrix[ 9] = sz * matrix[2 * 4 + 1];
                matrix[10] = sz * matrix[2 * 4 + 2];
                matrix[11] = sz * matrix[2 * 4 + 3];

                return this;
            }

            function zRotate(angle) {

                angle *=  Math.PI / 180

                var m00 = matrix[0 * 4 + 0];
                var m01 = matrix[0 * 4 + 1];
                var m02 = matrix[0 * 4 + 2];
                var m03 = matrix[0 * 4 + 3];
                var m10 = matrix[1 * 4 + 0];
                var m11 = matrix[1 * 4 + 1];
                var m12 = matrix[1 * 4 + 2];
                var m13 = matrix[1 * 4 + 3];
                var c = Math.cos(angle);
                var s = Math.sin(angle);

                matrix[ 0] = c * m00 + s * m10;
                matrix[ 1] = c * m01 + s * m11;
                matrix[ 2] = c * m02 + s * m12;
                matrix[ 3] = c * m03 + s * m13;
                matrix[ 4] = c * m10 - s * m00;
                matrix[ 5] = c * m11 - s * m01;
                matrix[ 6] = c * m12 - s * m02;
                matrix[ 7] = c * m13 - s * m03;

                return this;
            }

            return {
                matrix: matrix,
                identity: identity,
                orthographic: orthographic,
                multiply: multiply,
                inverse: inverse,
                translate: translate,
                scale: scale,
                zRotate: zRotate
            };
        }

        function draw(scale, tx, ty) {

            /*
            var matrix = m4.orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1);
            matrix = m4.translate(matrix, tx, ty, 0);
            matrix = m4.zRotate(matrix, 45 * Math.PI / 180);
            matrix = m4.scale(matrix, scale, scale, 1);
            matrix = m4.translate(matrix, gl.canvas.width / -2, gl.canvas.height / -2, 0);
            */

            var m = new M4()
                .orthographic(0, gl.canvas.width, gl.canvas.height, 0, -1, 1)
                .translate(tx, ty, 0)
                .zRotate(22.5)
                .scale(scale, scale, 1)
                .translate(gl.canvas.width / -2, gl.canvas.height / -2, 0);

            gl.uniformMatrix4fv(matrixLocation, false, m.matrix);
            gl.clear(gl.COLOR_BUFFER_BIT);

            var offset = 0;
            for(var i = 0; i < buffer.offsets.length; i++) {
                gl.uniform4fv(colorLocation, colors[i % 4]);
                gl.drawArrays(gl.TRIANGLES, offset, buffer.offsets[i] / pointSize);
                offset += buffer.offsets[i] / pointSize;
            }
        }

        function inflate(topology) {

            var geometries = [];

            Object.keys(topology.objects).forEach(function(key) {
                for(var i = 0; i < topology.objects[key].geometries.length; i++) {
                    var geometry = topology.objects[key].geometries[i];
                    var inflated = inflateGeometry(topology, geometry);
                    inflated.type = geometry.type;
                    geometries.push(inflated);
                }
            });

            return geometries;
        }

        function inflateGeometry(topology, geometry) {
            var inflated = { polygons: [] };
            geometry.arcs.forEach(function(arc) {
                if(geometry.type === "Polygon") {
                    inflated.polygons.push(stitch(topology, arc));
                }
                if(geometry.type === "MultiPolygon") {
                    var polygons = [];
                    for(var multi of arc) {
                        polygons.push(stitch(topology, multi));
                    }
                    inflated.polygons.push(polygons);
                }
            });
            return inflated;
        }

        function stitch(topology, arc) {
            const polygon = [];
            arc.forEach(function(index) {
                var coordinates = resolve(topology, index);
                polygon.push(...coordinates);
            });
            return polygon;
        }

        function resolve(topology, index) {
            var coordinates;
            if(index < 0) {
                coordinates = decodeArc(topology, topology.arcs[~index]);
                coordinates.reverse();
            }
            else {
                coordinates = decodeArc(topology, topology.arcs[index]);
            }
            return coordinates;
        }

        function decodeArc(topology, arc) {
            var x = 0, y = 0;
            return arc.map((point) => {
                return [
                    (x += point[0]) * topology.transform.scale[0] + topology.transform.translate[0],
                    (y += point[1]) * topology.transform.scale[1] + topology.transform.translate[1]
                ];
            });
        }

        function createBuffer(geometries) {
            var buffer = { data: [], offsets: [] };
            var offset = 0;

            geometries.forEach(function(geometry) {
                if(geometry.type === "Polygon") {
                    triangulate(geometry.polygons, buffer.data);
                }
                if(geometry.type === "MultiPolygon") {
                    for(let polygons of geometry.polygons) {
                        triangulate(polygons, buffer.data);
                    }
                }
                buffer.offsets.push(buffer.data.length - offset);
                offset = buffer.data.length;
            });

            return buffer;
        }

        function triangulate(polygons, data) {
            var points = earcut.flatten(polygons);
            var triangles = earcut(points.vertices, points.holes, points.dimensions);
            triangles.forEach(function(t) {
                var i = t * pointSize;
                data.push(points.vertices[i], points.vertices[i + 1]);
            });
        }

        function createShader(type, source) {
            var shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            gl.getShaderParameter(shader, gl.COMPILE_STATUS);
            var success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);
            if (!success) {
                gl.deleteShader(shader);
                throw new Error(gl.getShaderInfoLog(shader));
            }
            return shader;
        }

        function createProgram(vertexShader, fragmentShader) {
            var program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            gl.getProgramParameter(program, gl.LINK_STATUS);
            var success = gl.getProgramParameter(program, gl.LINK_STATUS);
            if (!success) {
                gl.deleteProgram(program);
                throw new Error(gl.getProgramInfoLog(program));
            }
            return program;
        }

        function toCanvasVector(x, y, v) {
            var rect = gl.canvas.getBoundingClientRect();
            var scaleX = (gl.canvas.width / rect.width);
            var scaleY = (gl.canvas.height / rect.height);
            v[0] = ((x - rect.left) * scaleX);
            v[1] = ((y - rect.top) * scaleY);
            v[2] = 0;
            v[3] = 1;
        }
    </script>
</body>
</html>
