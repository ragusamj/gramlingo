<!DOCTYPE html>
<html>
<head>
    <title>Phyllotaxis: Zooming a 2D Canvas with matrix magic</title>
</head>
<body style="text-align: center;">
    <canvas width="600" height="600"></canvas>
    <script>

        const canvas = document.querySelector('canvas');
        const context = canvas.getContext('2d');
        const radius = 2.5;
        const minScale = 1/2;
        const maxScale = 4;

        let current = { scale: 1, tx: 0, ty: 0, dx: 0, dy: 0 };
        let previous = current;
        let viewMatrix = new DOMMatrix();

        const render = () => {

            viewMatrix = new DOMMatrix()
                .translateSelf(current.tx, current.ty)
                .scaleSelf(current.scale)
                .scaleSelf(1 / previous.scale)
                .translateSelf(current.dx, current.dy)
                .translateSelf(-previous.dx, -previous.dy)
                .translateSelf(-current.tx, -current.ty)
                .multiplySelf(viewMatrix);

            previous = Object.assign({}, current);

            context.save();
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.setTransform(viewMatrix.a, viewMatrix.b, viewMatrix.c, viewMatrix.d, viewMatrix.e, viewMatrix.f);
            context.beginPath();
            points.forEach(drawPoint);
            context.fill();
            context.restore();
        }

        const drawPoint = (point, index) => {
            context.moveTo(point[0] + radius, point[1]);
            context.arc(point[0], point[1], radius, 0, 2 * Math.PI);
        }

        const phyllotaxis = radius => {
            const theta = Math.PI * (3 - Math.sqrt(5));
            return i => {
                const r = radius * Math.sqrt(i), a = theta * i;
                return [
                    canvas.width / 2 + r * Math.cos(a),
                    canvas.height / 2 + r * Math.sin(a)
                ];
            };
        }

        const points = Array
            .from(new Array(2000))
            .map((v, i) => { return i + 1; })
            .map(phyllotaxis(10));

        const noevent = e => {
            e.preventDefault();
            e.stopImmediatePropagation();
        }

        canvas.addEventListener('wheel', e => {
            noevent(e);
            requestAnimationFrame(() => {
                const delta = -e.deltaY * (e.deltaMode ? 120 : 1) / 500;
                current.scale = Math.max(minScale, Math.min(maxScale, current.scale * Math.pow(2, delta)));
                current.tx = e.offsetX;
                current.ty = e.offsetY;
                render();
            });
        });

        canvas.addEventListener('mousedown', e => {
            if(e.button !== 0) { return; }
            noevent(e);

            const dx = e.offsetX - current.dx;
            const dy = e.offsetY - current.dy;

            const mousemove = e => {
                noevent(e);
                current.dx = e.offsetX - dx;
                current.dy = e.offsetY - dy;
                render();
            }

            const mouseup = e => {
                noevent(e);
                canvas.removeEventListener('mousemove', mousemove);
                canvas.removeEventListener('mouseup', mouseup);
            }

            canvas.addEventListener('mousemove', mousemove);
            canvas.addEventListener('mouseup', mouseup);
        });

        render();

    </script>
</body>
</html>